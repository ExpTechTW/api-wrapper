!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("events")):"function"==typeof define&&define.amd?define(["exports","events"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@exptechtw/api-wrapper"]={},e.events)}(this,(function(e,t){"use strict";class s{version;key;constructor(e={}){this.version=e.version??2,this.key=e.key??""}randomServerUrl(){return`https://api-${Math.ceil(2*Math.random())}.exptech.com.tw`}randomLoadBalancerUrl(){return`https://lb-${Math.ceil(4*Math.random())}.exptech.com.tw`}randomServerBaseUrl(){return`${this.randomLoadBalancerUrl()}/api/v${this.version}`}randomLoadBalancerBaseUrl(){return`${this.randomLoadBalancerUrl()}/api/v${this.version}`}static websocket(){return`wss://lb-${Math.ceil(4*Math.random())}.exptech.com.tw/websocket`}earthquakeReportList(e=50){return`${this.randomServerBaseUrl()}/eq/report?limit=${e}&key=${this.key}`}earthquakeReport(e){return`${this.randomServerBaseUrl()}/eq/report/${e}`}rts(e){return e?`${this.randomLoadBalancerBaseUrl()}/trem/rts/${e}`:`${this.randomLoadBalancerBaseUrl()}/trem/rts`}rtsImage(e){return e?`${this.randomLoadBalancerBaseUrl()}/trem/rts-image/${e}`:`${this.randomLoadBalancerBaseUrl()}/trem/rts-image`}eew(e,t){return e?t?`${this.randomLoadBalancerBaseUrl()}/eq/eew/${e}?type=${t}`:`${this.randomLoadBalancerBaseUrl()}/eq/eew/${e}`:t?`${this.randomLoadBalancerBaseUrl()}/eq/eew?type=${t}`:`${this.randomLoadBalancerBaseUrl()}/eq/eew`}station(){return`${this.randomLoadBalancerUrl()}/file/resource/station.json`}}var r,a;e.EewSource=void 0,(r=e.EewSource||(e.EewSource={})).Cwa="cwa",r.Kma="kma",r.Jma="jma",r.Nied="nied",r.Scdzj="scdzj",e.EewStatus=void 0,(a=e.EewStatus||(e.EewStatus={}))[a.Warn=0]="Warn",a[a.Alert=1]="Alert",a[a.Cancel=2]="Cancel",a[a.Test=3]="Test";class o extends t.EventEmitter{key;route;constructor(e){super(),this.key=e??"",this.route=new s({key:this.key})}setApiKey(e){return this.key=e,this.route.key=e,this}async#e(e){const t=new Request(e,{method:"GET",cache:"default",headers:{Accept:"application/json"}}),s=await fetch(t);if(!s.ok)throw new Error(`Server returned ${s.status}`);return s}async getStations(){const e=this.route.station();return(await this.#e(e)).json()}async getReports(e){const t=this.route.earthquakeReportList(e),s=await(await this.#e(t)).json();for(const e of s)e.no=+e.id.split("-")[0];return s}async getReport(e){const t=this.route.earthquakeReport(`${e}`),s=await(await this.#e(t)).json();return s.no=+s.id.split("-")[0],s.int=Object.keys(s.list).reduce(((e,t)=>s.list[t].int>e?s.list[t].int:e),0),s.list=Object.keys(s.list).map((e=>({area:e,int:s.list[e].int,stations:Object.keys(s.list[e].town).map((t=>({...s.list[e].town[t],station:t}))).sort(((e,t)=>t.int-e.int))}))).sort(((e,t)=>t.int-e.int)),s}async getRts(e){const t=this.route.rts(e?`${e}`:"");return(await this.#e(t)).json()}async getRtsImage(e){const t=this.route.rtsImage(e?`${e}`:"");return(await this.#e(t)).arrayBuffer()}async getEew(e,t){const s=this.route.eew(e?`${e}`:"");return(await this.#e(s)).json()}}var i,n,c;e.WebSocketEvent=void 0,(i=e.WebSocketEvent||(e.WebSocketEvent={})).Eew="eew",i.Info="info",i.Ntp="ntp",i.Report="report",i.Rts="rts",i.Verify="verify",i.Close="close",i.Error="error",e.SupportedService=void 0,(n=e.SupportedService||(e.SupportedService={})).RealtimeStation="trem.rts",n.RealtimeWave="trem.rtw",n.Eew="websocket.eew",n.TremEew="trem.eew",n.Report="websocket.report",n.Tsunami="websocket.tsunami",n.TremIntensity="trem.intensity",n.CwaIntensity="cwa.intensity",e.WebSocketCloseCode=void 0,(c=e.WebSocketCloseCode||(e.WebSocketCloseCode={}))[c.InsufficientPermission=4e3]="InsufficientPermission";class l extends t.EventEmitter{ws;websocketConfig;constructor(e){super(),this.websocketConfig=e,this.#t()}#t(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close();const t=s.websocket();this.ws=new WebSocket(t),this.ws.addEventListener("open",(()=>{this.ws.send(JSON.stringify(this.websocketConfig))})),this.ws.addEventListener("message",(t=>{try{const s=JSON.parse(t.data);if(s)switch(s.type){case e.WebSocketEvent.Verify:this.ws.send(JSON.stringify(this.websocketConfig));break;case e.WebSocketEvent.Info:switch(s.data.code){case 200:if(!s.data.list.length){this.ws.close(e.WebSocketCloseCode.InsufficientPermission);break}break;case 503:window.setTimeout((()=>this.ws.send(JSON.stringify(this.websocketConfig))),5e3)}break;case"data":switch(s.data.type){case e.WebSocketEvent.Rts:this.emit(e.WebSocketEvent.Rts,s.data.data);break;case e.WebSocketEvent.Eew:this.emit(e.WebSocketEvent.Eew,s.data);break;case e.WebSocketEvent.Report:this.emit(e.WebSocketEvent.Report,s.data.data)}break;case e.WebSocketEvent.Ntp:this.emit(e.WebSocketEvent.Ntp,s)}}catch(t){this.emit(e.WebSocketEvent.Error,t)}})),this.ws.addEventListener("close",(t=>{console.log("[WebSocket] Socket closed"),this.emit(e.WebSocketEvent.Close,t),t.code!=e.WebSocketCloseCode.InsufficientPermission&&window.setTimeout(this.#t.bind(this),5e3)})),this.ws.addEventListener("error",(e=>{console.error("[WebSocket]",e)}))}}e.ExpTechApi=o,e.ExpTechWebsocket=l,e.Intensity=[{value:0,label:"0",text:"０級"},{value:1,label:"1",text:"１級"},{value:2,label:"2",text:"２級"},{value:3,label:"3",text:"３級"},{value:4,label:"4",text:"４級"},{value:5,label:"5-",text:"５弱"},{value:6,label:"5+",text:"５強"},{value:7,label:"6-",text:"６弱"},{value:8,label:"6+",text:"６強"},{value:9,label:"7",text:"７級"}]}));
