!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("events")):"function"==typeof define&&define.amd?define(["exports","events"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@exptechtw/api-wrapper"]={},e.events)}(this,(function(e,t){"use strict";class s{version;key;constructor(e={}){this.version=e.version??3,this.key=e.key??""}randomServerUrl(){return`https://api-${Math.ceil(2*Math.random())}.exptech.com.tw`}randomLoadBalancerUrl(){return`https://lb-${Math.ceil(4*Math.random())}.exptech.com.tw`}randomServerBaseUrl(){return`${this.randomLoadBalancerUrl()}/api/v${this.version}`}randomLoadBalancerBaseUrl(){return`${this.randomLoadBalancerUrl()}/api/v${this.version}`}static websocket(){return`wss://lb-${Math.ceil(4*Math.random())}.exptech.com.tw/websocket`}login(e=1){return`https://api-${e}.exptech.com.tw/api/v${this.version}/et/login`}earthquakeReportList(e=50){return`${this.randomServerBaseUrl()}/eq/report?limit=${e}&key=${this.key}`}earthquakeReport(e){return`${this.randomServerBaseUrl()}/eq/report/${e}`}static rts(e){const t=`https://lb-${Math.ceil(4*Math.random())}.exptech.com.tw/api/v1`;return e?`${t}/trem/rts/${e}`:`${t}/trem/rts`}rtsImage(e){return e?`${this.randomLoadBalancerBaseUrl()}/trem/rts-image/${e}`:`${this.randomLoadBalancerBaseUrl()}/trem/rts-image`}static eew(e,t){const s=`https://lb-${Math.ceil(4*Math.random())}.exptech.com.tw/api/v1`;return e?t?`${s}/eq/eew/${e}?type=${t}`:`${s}/eq/eew/${e}`:t?`${s}/eq/eew?type=${t}`:`${s}/eq/eew`}station(){return"https://raw.githubusercontent.com/exptechtw/api/master/resource/station.json"}}var r,a;e.EewSource=void 0,(r=e.EewSource||(e.EewSource={})).Cwa="cwa",r.Kma="kma",r.Jma="jma",r.Nied="nied",r.Scdzj="scdzj",r.Trem="trem",e.EewStatus=void 0,(a=e.EewStatus||(e.EewStatus={}))[a.Warn=0]="Warn",a[a.Alert=1]="Alert",a[a.Cancel=2]="Cancel",a[a.Test=3]="Test";class i extends t.EventEmitter{key;route;headers;constructor(e,t){super(),this.key=e??"",this.headers=t??{Accept:"application/json","Content-Type":"application/json"},this.route=new s({key:this.key})}setApiKey(e){return this.key=e,this.route.key=e,this}async#e(e){const t=new Request(e,{method:"GET",cache:"default",headers:{...this.headers,Accept:"application/json"}}),s=await fetch(t);if(!s.ok)throw new Error(`Server returned ${s.status}`);return s}async#t(e,t){const s=new Request(e,{method:"POST",cache:"default",headers:{...this.headers,Accept:"application/json"},body:t}),r=await fetch(s);if(!r.ok)throw new Error(`Server returned ${r.status}`);return r}async getStations(){const e=this.route.station();return(await this.#e(e)).json()}async getReportList(e){const t=this.route.earthquakeReportList(e),s=await(await this.#e(t)).json();for(const e of s)e.no=+e.id.split("-")[0];return s}async getReport(e){const t=this.route.earthquakeReport(`${e}`),s=await(await this.#e(t)).json();return s.no=+s.id.split("-")[0],s.int=Object.keys(s.list).reduce(((e,t)=>s.list[t].int>e?s.list[t].int:e),0),s.list=Object.keys(s.list).map((e=>({area:e,int:s.list[e].int,stations:Object.keys(s.list[e].town).map((t=>({...s.list[e].town[t],station:t}))).sort(((e,t)=>t.int-e.int))}))).sort(((e,t)=>t.int-e.int)),s}async getRts(e){const t=s.rts(e?`${e}`:"");return(await this.#e(t)).json()}async getRtsImage(e){const t=this.route.rtsImage(e?`${e}`:"");return(await this.#e(t)).arrayBuffer()}async getEew(e,t){const r=s.eew(e?`${e}`:"");return(await this.#e(r)).json()}async getAuthToken(e,t=1){const s=this.route.login(t),r=JSON.stringify({email:e.email,pass:e.password,name:e.name});return(await this.#t(s,r)).text()}}var n,o;e.WebSocketEvent=void 0,(n=e.WebSocketEvent||(e.WebSocketEvent={})).Eew="eew",n.Info="info",n.Ntp="ntp",n.Report="report",n.Rts="rts",n.Rtw="rtw",n.Verify="verify",n.Close="close",n.Error="error",e.SupportedService=void 0,(o=e.SupportedService||(e.SupportedService={})).RealtimeStation="trem.rts",o.RealtimeWave="trem.rtw",o.Eew="websocket.eew",o.TremEew="trem.eew",o.Report="websocket.report",o.Tsunami="websocket.tsunami",o.CwaIntensity="cwa.intensity",o.TremIntensity="trem.intensity";class c extends t.EventEmitter{ws;websocketConfig;constructor(e){super(),this.websocketConfig={...e,type:"start"},this.#s()}#s(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close();const t=s.websocket();this.ws=new WebSocket(t),this.ws.addEventListener("open",(()=>{this.ws.send(JSON.stringify(this.websocketConfig))})),this.ws.addEventListener("message",(t=>{try{const s=JSON.parse(t.data);if(s)switch(s.type){case e.WebSocketEvent.Verify:this.ws.send(JSON.stringify(this.websocketConfig));break;case e.WebSocketEvent.Info:switch(this.emit(e.WebSocketEvent.Info,s.data),s.data.code){case 200:break;case 503:setTimeout((()=>this.ws.send(JSON.stringify(this.websocketConfig))),5e3)}break;case"data":switch(s.data.type){case e.WebSocketEvent.Rts:this.emit(e.WebSocketEvent.Rts,s.data.data);break;case e.WebSocketEvent.Rtw:this.emit(e.WebSocketEvent.Rtw,s.data);break;case e.WebSocketEvent.Eew:this.emit(e.WebSocketEvent.Eew,s.data);break;case e.WebSocketEvent.Report:this.emit(e.WebSocketEvent.Report,s.data.data)}break;case e.WebSocketEvent.Ntp:this.emit(e.WebSocketEvent.Ntp,s)}}catch(t){this.emit(e.WebSocketEvent.Error,t)}})),this.ws.addEventListener("close",(t=>{this.emit(e.WebSocketEvent.Close,t)})),this.ws.addEventListener("error",(t=>{this.emit(e.WebSocketEvent.Error,t)}))}updateConfig(e){this.websocketConfig={...e,type:"start"},this.ws.send(JSON.stringify(this.websocketConfig))}}e.ExpTechApi=i,e.ExpTechWebsocket=c,e.Intensity=[{value:0,label:"0",text:"０級"},{value:1,label:"1",text:"１級"},{value:2,label:"2",text:"２級"},{value:3,label:"3",text:"３級"},{value:4,label:"4",text:"４級"},{value:5,label:"5-",text:"５弱"},{value:6,label:"5+",text:"５強"},{value:7,label:"6-",text:"６弱"},{value:8,label:"6+",text:"６強"},{value:9,label:"7",text:"７級"}]}));
